stages:
  - prepare
  - verify
  - pages

variables:
  PUBLIC_DIR: public

prepare:
  stage: prepare
  image: node:18-alpine
  before_script:
    - apk add --no-cache rsync bash coreutils findutils
  script:
    - set -euo pipefail
    - rm -rf "$PUBLIC_DIR" || true
    - mkdir -p "$PUBLIC_DIR"
    - rsync -a --exclude='.git' --exclude='.gitlab' --exclude='.gitlab-ci.yml' --exclude='node_modules' --exclude='venv' --exclude='*.bak' ./ "$PUBLIC_DIR"/
    - echo "Prepared $PUBLIC_DIR:"
    - ls -la "$PUBLIC_DIR" | sed -n '1,200p'
  artifacts:
    paths:
      - "$PUBLIC_DIR"
    expire_in: 1 hour
  only:
    - main

verify:
  stage: verify
  image: node:18-alpine
  dependencies:
    - prepare
  before_script:
    - apk add --no-cache bash grep sed awk coreutils findutils
  script:
    - set -euo pipefail
    - echo "Scanning HTML files for local asset references..."
    - |
      refs=$(grep -RohE '(src|href)=["'"'"']/?[^"'"'"']+["'"'"']' "$PUBLIC_DIR" 2>/dev/null | sed -E 's/^(src|href)=["'"'"']//; s/["'"'"']$//' | sed 's#^/##' | sort -u || true)
    - echo "Found references (first 200 lines):"; echo "$refs" | sed -n '1,200p' || true
    - missing=0
    - |
      for ref in $refs; do
        if echo "$ref" | grep -qE '^(https?:|//|mailto:|tel:|data:|#)'; then
          continue
        fi
        path="$PUBLIC_DIR/$ref"
        if [ -d "$path" ]; then
          path="$path/index.html"
        fi
        if [ ! -f "$path" ]; then
          echo "MISSING: $ref -> expected at $PUBLIC_DIR/$ref"
          missing=1
        fi
      done
    - if [ "$missing" -eq 1 ]; then echo "One or more referenced assets are missing."; exit 2; fi
    - echo "Verify passed: all referenced local assets exist in $PUBLIC_DIR (basic check)."
  artifacts:
    when: on_failure
    paths:
      - "$PUBLIC_DIR"
  only:
    - main

pages:
  stage: pages
  image: node:18-alpine
  dependencies:
    - prepare
    - verify
  script:
    - echo "Publishing $PUBLIC_DIR (contents below):"
    - ls -la "$PUBLIC_DIR" | sed -n '1,200p'
  artifacts:
    paths:
      - "$PUBLIC_DIR"
  only:
    - main
